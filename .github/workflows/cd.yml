name: CD

on:
  pull_request:
    types: [closed]
    branches:
      - main

env:
  CARGO_TERM_COLOR: always

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Rust
        uses: actions-rs/toolchain@v1

      - name: Run integration tests
        run: |
          cargo build --release
          cargo test --release
          cargo fmt -- --check
          cargo clippy -- -D warnings
          ./tools/test.sh
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          cargo install cargo-bump cargo-metadata

      - name: Current version
        id: curr_version
        run: echo "current_version=$(cargo metadata --no-deps --format-version=1 | jq -r '.packages[0].version')" >> $GITHUB_ENV

      - name: Bump version using cargo-bump
        run: cargo bump patch

      - name: Next version
        id: next_version
        run: echo "next_version=$(cargo metadata --no-deps --format-version=1 | jq -r '.packages[0].version')" >> $GITHUB_ENV

      - name: Update dependencies & ensure version changed
        if: ${{ env.current_version != env.next_version }}
        run: cargo update --aggressive
        env:
          current_version: ${{ steps.curr_version.outputs.current_version }}
          next_version: ${{ steps.next_version.outputs.next_version }}

      - name: Commit changes and tag release
        if: ${{ env.current_version != env.next_version }}
        run: |
          git add Cargo.lock Cargo.toml
          git commit -m "Update dependencies for version ${{ env.next_version }}"
          git tag -a "v${{ env.next_version }}" -m "Release v${{ env.next_version }}"
          git push origin main
          git push origin "v${{ env.next_version }}"
        env:
          current_version: ${{ steps.curr_version.outputs.current_version }}
          next_version: ${{ steps.next_version.outputs.next_version }}

      - name: Publish to crates.io
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Success message
        run: echo "Successfully published version ${{ env.next_version }}"
        env:
          next_version: ${{ steps.next_version.outputs.next_version }}
